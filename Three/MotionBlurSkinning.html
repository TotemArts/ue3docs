<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title> UDK | MotionBlurSkinning    </title>

<style type="text/css" media="all">@import "rsrc/twiki_webs.css";</style>
<style type="text/css" media="all">@import "rsrc/udn_new.css";</style>
<link rel="icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />


<!-- view.static_udn3.tmpl  -->
<script language="JavaScript" type="text/javascript" src="rsrc/udn.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

</head>
<p />
<body id="webbgThree">
<p />

<p />
<div id="webThree"><div id="head">
<!--
<div class="header">
 -->
<div style="background: url(/pub/webbg_udn.jpg); background-repeat: no-repeat; height:140px; width: 100%;" >
<!--
<div style="background: transparent url(/pub/udn_header_bg.jpg); background-repeat: repeat-x; height:140px; width: 100%; margin-left: 991px;">
 -->
<p />
<div id="nav">
<ul class="nav">
<font color=black>|</font>&nbsp;&nbsp;<li class=nav_Three><a href="../Main/WebHome.html" class="twikiLink">Main</a></li><font color=black>|</font><li class=nav_Three><a href="../Two/WebHome.html" class="twikiLink">UnrealEngine2</a></li><font color=black>|</font><li class=nav_Three><a href="WebHome.html" class="twikiLink">UnrealEngine3</a></li><font color=black>|</font><li class=nav_Three><a href="https://docs.unrealengine.com" class="twikiLink">UnrealEngine4</a></li><font color=black>|</font><li class=nav_Three><a href="../Main/BusinessAndLegal.html" class="twikiLink">Business &amp; Legal</a></li><font color=black>|</font>
</ul><br><br><br>
</div>
</div>
</div> <!-- end head -->
<div id="pagedefault">
<div id="maincol">
<div id="tool">
<div id="tooltop">UDN</div>
<div id="tooltext" style="padding: 10px 10px 10px 10px;">
Search public documentation: <br>
<form ACTION="/search/index.php" METHOD="GET" NAME="main" ID="main">
<input TYPE="TEXT" NAME="q" SIZE="15" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;">
<input TYPE="SUBMIT" VALUE="Search" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;"><br>
</form>
</div>
<div id="toolband">MotionBlurSkinning  </b></div>
<div id="tooltext">
<a href="MotionBlurSkinningJP.html" class="twikiLink">日本語訳</a><br><a href="MotionBlurSkinningCH.html" class="twikiLink">中国翻译</a><br><a href="MotionBlurSkinningKR.html" class="twikiLink">한국어</a><br>

<!-- Three/MotionBlurSkinning -->
<hr size="1" noshade="noshade" />
Interested in the Unreal Engine? <br>
Visit the <a href="http://www.unrealtechnology.com" target="_top">Unreal Technology</a> site.<br>
<br>
Looking for jobs and company info? <br>
Check out the <a href="http://www.epicgames.com" target="_top">Epic games</a> site.<br>
<br>
Questions about support via UDN? <br>
Contact the <a href="../Main/ContactUDNStaff.html" class="twikiLink">UDN Staff</a> <br>
<br>
</div> <!-- end toolbox content -->
<div id="toolbottom"></div>
</div> <!-- end tool -->
<p />
<noautolink>
<p />
<div style="padding:0px 0px 0px 4px;font:10px Verdana;">
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="PostProcessEffectsHome.html" class="twikiLink">Post Process Effects</a></b> &gt; MotionBlur Skinning Post Process Feature <br/>
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="CinematicArtistHome.html" class="twikiLink">Cinematic Artist</a></b> &gt; MotionBlur Skinning Post Process Feature
</div>
<hr size="1" noshade="noshade">
<h1><a name="MotionBlur Skinning Post Process Feature"></a> MotionBlur Skinning Post Process Feature </h1>
<hr size="1" noshade="noshade">
<p />
<table cellspacing="0" cellpadding="1" class="twikiTable" border="0"><tr><td bgcolor="#eaeaea" class="twikiFirstCol"> <img src="rsrc/Three/MotionBlurSkinning/3small.png" alt="3small.png" width='355' height='422' /> </td></tr>
<tr><td bgcolor="#ffffff" class="twikiFirstCol"> <SMALL>Body parts moving in different directions show different motion blur direction and strength.</SMALL> </td></tr>
</table>
<br>
<p />
<p />
<div class="twikiToc"> <ul>
<li> <a href="MotionBlurSkinning.html#MotionBlur Skinning Post Process Feature"> MotionBlur Skinning Post Process Feature</a> <ul>
<li> <a href="MotionBlurSkinning.html#Overview"> Overview</a>
</li> <li> <a href="MotionBlurSkinning.html#Activate the feature"> Activate the feature</a>
</li> <li> <a href="MotionBlurSkinning.html#Setting the _SkeletalMesh flag"> Setting the SkeletalMesh flag</a>
</li> <li> <a href="MotionBlurSkinning.html#Implementation"> Implementation</a> <ul>
<li> <a href="MotionBlurSkinning.html#Limited bone count"> Limited bone count</a>
</li> <li> <a href="MotionBlurSkinning.html#Shader permutation"> Shader permutation</a>
</li></ul>
</li> <li> <a href="MotionBlurSkinning.html#Performance"> Performance</a> <ul>
<li> <a href="MotionBlurSkinning.html#CPU data update"> CPU data update</a>
</li> <li> <a href="MotionBlurSkinning.html#More draw calls"> More draw calls</a>
</li> <li> <a href="MotionBlurSkinning.html#Vertex texture fetch GPU cost"> Vertex texture fetch GPU cost</a>
</li></ul>
</li> <li> <a href="MotionBlurSkinning.html#Memory"> Memory</a>
</li> <li> <a href="MotionBlurSkinning.html#Support on different platforms"> Support on different platforms</a>
</li> <li> <a href="MotionBlurSkinning.html#Optimizations:"> Optimizations:</a>
</li> <li> <a href="MotionBlurSkinning.html#Useful console commands"> Useful console commands</a>
</li></ul>
</li></ul>
</div>
<p />
<h2><a name="Overview"></a> Overview </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Recommended read: <a href="MotionBlur.html" class="twikiLink">MotionBlur</a>
<p />
Before implementing the <strong>motion blur skinning</strong> we only supported <strong>rigid motion blur</strong> based on camera and object motion (translation, rotation, scale). Skinned meshes derived the object motion from the root of the object which can be a good approximation for simple objects but not for characters. There different parts of the body move in different directions and that requires a more sophisticated method.
<p />
<table cellspacing="0" cellpadding="1" class="twikiTable" border="0"><tr><td bgcolor="#eaeaea" class="twikiFirstCol"> <img src="rsrc/Three/MotionBlurSkinning/PerBoneMotionBlur.jpg" alt="PerBoneMotionBlur.jpg" width='672' height='350' /> </td></tr>
<tr><td bgcolor="#ffffff" class="twikiFirstCol"> <SMALL>Left: feature off<br>Middle: feature on<br>Right: Per pixel velocity shown as color.</SMALL> </td></tr>
</table>
<p />
Skinned motion blur requires some extra CPU and GPU performance and has some extra memory cost. Because of that is should be used only where needed. For all other objects <strong>rigid skinned motion</strong> blur is still available.
<p />
<h2><a name="Activate the feature"></a> Activate the feature </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
If supported by the platform (see later section about this topic) it can be activated by the ini setting "MotionBlurSkinning" that can be found in "BaseEngine.ini" or later at runtime with the "MotionBlurSkinning" console command.
<p />
The number specified in the ini setting is the same that is used by the console command. It not only allows to switch the feature on (1) or off (0) but also to override the per object flag to force it for all objects (2). The current state and some help can be seen when using the console command without extra parameters:
<p />
<table cellspacing="0" cellpadding="1" class="twikiTable" border="0"><tr><td bgcolor="#eaeaea" class="twikiFirstCol"> <img src="rsrc/Three/MotionBlurSkinning/ConsoleMotionBlurSkinning.jpg" alt="ConsoleMotionBlurSkinning.jpg" width='264' height='137' /> </td></tr>
<tr><td bgcolor="#ffffff" class="twikiFirstCol"> <SMALL>Response when using the MotionBlurSkinning console command.</SMALL> </td></tr>
</table>
<p />
<h2><a name="Setting the _SkeletalMesh flag"></a> Setting the SkeletalMesh flag </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
The flag is called <strong>bPerBoneMotionBlur</strong> and can be set by code (e.g. UnrealScript) or when placing an object in the level.
<p />
     <img src="rsrc/Three/MotionBlurSkinning/editorflag.jpg" alt="editorflag.jpg" width='425' height='382' />
<p />
<h2><a name="Implementation"></a> Implementation </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Skinned motion blur is outputting the per pixel motion vector into the velocity texture (currently black for the camera motion, color for object motion, more details: <a href="MotionBlur.html" class="twikiLink">MotionBlur</a>). After rendering all velocities the following steps don't see any difference between <strong>rigid motion blur</strong> or <strong>skinned motion blur</strong>.
<p />
We store all the bone data for all objects used in the frame in a texture for use in the next frame. This means we always need two textures as we read from one (GPU) and write to one (CPU) at the same frame. This minimizes the texture lock count. Changing the engine to use triple buffering someone might have to add another buffer to this chain.
<p />
It would have been possible to implement the feature with vertex shader constants but because there is a limit of those constants we have a challenge to get the data into the shader. The GPU skinning is already using almost all constants and for skinned motion blur we require the double amount (we need both the current bone matrix and the former one). Packing the data might be an option (e.g. quaternion + scale + position) but not without further complications. Splitting the draw calls into chunks of half the bone count would be another way of solving the problem but that is likely to slow down render performance for other passes and adds more complications to the content preparation (cooking / importing).
<p />
We decided to implemented the skinned motion blur by using "vertex texture fetch". This GPU feature is not support on all hardware, in particular earlier ShaderModel 3.0 hardware (AMD/ATI) doesn't support that.
<p />
We update the textures with the bone data from the CPU. For good texture cache performance we use a 1D texture.
<p />
We split the mesh into chunks to respect the limited bone count (limited vertex shader constants) and to split the mesh by materials.
<p />
Bones can appear duplicated as we use the per chunk index and that indexes into a subset of the bones.
<p />
<h3><a name="Limited bone count"></a> Limited bone count </h3>
<p />
As we use a 1D texture to store the bone data there are limits on the bone count. We currently use a 4096 wide texture and need to store 3 texels per bone. Use the <strong>stat SceneUpdate</strong> command to see if this limit affects you. We do motion blur only for nearby objects and with the bone count we use we haven't seen this being an issue. Note that motion blur for facial animation often doesn't require the MotionBlurSkinning feature.
<p />
<h3><a name="Shader permutation"></a> Shader permutation </h3>
<p />
We tried to avoid the shader permutation for having skinned motion blur and not having it. This was mostly to keep code complexity low but also to have less shaders in general. We decided to use static branching (compare on bool shader constant) as this solves the problem and is optimized out by the driver.
<p />
On Xbox360 we use static branching to avoid a shader permutation. We verified, this is as fast as compiled out. Other platforms don't make use of this yet (see Optimizations section).
<p />
<h2><a name="Performance"></a> Performance </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
<h3><a name="CPU data update"></a> CPU data update </h3>
<p />
The CPU cost of skinned motion blur is not high as the data from former frames is stored and reused for the following frame. The texture lock operation should not stall as we only double buffer but to make sure we have a <strong>stat</strong> on this. By using the console command <strong>stat SceneUpdate</strong> you can look at this number.
<p />
<table cellspacing="0" cellpadding="1" class="twikiTable" border="0"><tr><td bgcolor="#eaeaea" class="twikiFirstCol"> <img src="rsrc/Three/MotionBlurSkinning/StatSceneUpdate.jpg" alt="StatSceneUpdate.jpg" width='558' height='236' /> </td></tr>
<tr><td bgcolor="#ffffff" class="twikiFirstCol"> <SMALL>The statistics show the CPU time for the lock and the amount of bones that have been updated.</SMALL> </td></tr>
</table>
<p />
<h3><a name="More draw calls"></a> More draw calls </h3>
<p />
Motion blurred object need to be rendered in the velocity rendering pass (to store the per pixel motion vector). For non skinned motion blur we only need to do this if there is object motion. To test if a skinned object has no motion we would need to check much more data. We don't do this optimization yet. It can be done but it won't help the worst case of many moving object.
<p />
That means when enabling the skinned motion blur for an object that was not moving (e.g. bot not moving) it now needs to be rendered and that adds more draw calls.
<p />
<h3><a name="Vertex texture fetch GPU cost"></a> Vertex texture fetch GPU cost </h3>
<p />
The current method requires 12 vertex texture fetches into a very big vertex format (4 floats for one bone 4x3 matrix, 4 bones for skinning). This means the more vertices need to be rendered this way the slower it renders. Only nearby objects get rendered this way (velocity rendering pass) so the render cost might peak up with a lot of nearby action.
<p />
When profiling the velocity rendering pass on Xbox360 (dense triangle meshes with morph) we noticed the rendering being 60% slower than with rigid motion blur (all objects moved and therefore rendering cannot be skipped).
<p />
<h2><a name="Memory"></a> Memory </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
The memory occupied by the feature is constant as the two textures that store the data have a fixed size. This avoids reallocations performance loss and memory fragmentation. In order to see how much memory is occupied we track this memory. You can look at the data by using the <strong>stat memory</strong> console command:
<p />
     <img src="rsrc/Three/MotionBlurSkinning/StatMemory.jpg" alt="StatMemory.jpg" width='573' height='107' />
<p />
<h2><a name="Support on different platforms"></a> Support on different platforms </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Our implementation is based on the <strong>vertex texture fetch</strong> which is not available on all GPUs. We currently support skinned motion blur on Direct3D 9 (if hardware supports it) and on Xbox360. Adding support for Playstation 3 should be simple but is expected to be too slow (assuming texture fetch implementation and high vertex count). Future DirectX version will be supported at a later stage. Support for mobile hardware is currently not planned (performance reasons).
<p />
If not supported the engine automatically utilizes <strong>rigid skinned motion blur</strong> instead.
<p />
<h2><a name="Optimizations:"></a> Optimizations: </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p /> <ul>
<li> On Xbox360 the "vfetch" feature can be used instead of the vertex texture fetch.
</li> <li> We could do less than 4 bone lookups per vertex (degrades quality but might be acceptable).
</li> <li> We could check the bPerBoneMotionBlur at runtime to allow game code to disable when it knows the objects is not moving (Simple but requires effort on game code to be useful).
</li> <li> Utilize static branching on PC and Playstation 3. We have an engine bug that prevents us from using that. As a workaround we check the state of a float to disable the feature (means even non skinned objects pay the cost of the heavy shader in the velocity rendering pass).
</li> <li> We currently lock the whole texture even if only part of it is used.
</li> <li> Test if velocity rendering is needed by comparing all bones against the former ones.
</li></ul>
<p />
<h2><a name="Useful console commands"></a> Useful console commands </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p /> <dl>
<dt> <code><b>MotionBlurSkinning</b></code> </dt><dd> as described above
</dd></dl>
<p />
</noautolink>
<p />
<p />
<p />
<p />
<p />
<p />


<!-- BEGIN UE4 NOTICE -->



<div id="version_message" style="display:none;">

    <div style="position:fixed;top:0px;left:0px;width:100%;height:100%;background:#000;opacity:0.5;">

    </div>

    <div style="position:fixed;top:50%;left:50%;margin:-70px 0px 0px -240px;background:#FFF;border-radius:6px;width:480px;box-shadow:0px 5px 30px -5px rgba(0,0,0,0.9);">

        <div style="font-size:16px;font-weight:bold;background: url(rsrc/Three/warning.png) no-repeat scroll 5px 5px;padding:4px 10px 5px 25px;height:21px;width:440px;">

            Important!

        </div>

        <div style="font-size:11px;padding:5px 10px 10px;width:460px;">

            <p>You are viewing documentation for the <strong>Unreal Development Kit (UDK)</strong>.</p>



            <p>If you are looking for the Unreal Engine 4 documentation, please visit the <a style="color:#000;" href="https://docs.unrealengine.com">Unreal Engine 4 Documentation</a> site.</p>

        </div>

        <div style="height:20px;padding:4px;margin:6px;border-top:1px solid #a0a0a0;">

            <form onsubmit="return closeVersionMessage();">

                <input type="checkbox" id="dismiss" value="dismiss" />

                <label for="dsimiss">Don't show me this again</label>

                <input type="submit" value="Close" style="cursor:pointer;float:right;width:60px;color:#f0f0f0;font-weight:bold;background:#882222;height:24px;padding:2px 3px 3px;text-align:center;border:1px outset #000;" />

            </form>

        </div>

    </div>

</div>



<script type="text/javascript">

    window.onload = function () {

        LoadVersionMessage();

    }



    function LoadVersionMessage()

    {

        var showMessage = "false";
        if(showMessage != "false")

        {

            showVersionMessage();

        }

    }



    function showVersionMessage()

    {

        var message = document.getElementById("version_message");

        if(message)

        {

            message.style.display = "block";

        }

    }



    function closeVersionMessage() {

        var dismiss = document.getElementById("dismiss");

        var message = document.getElementById("version_message");

        if (message) {

            message.style.display = "none";

        }

        if (dismiss.checked) {

            eraseCookie("doc_version_message");

            createCookie("doc_version_message", "false", 365);

            dismiss.checked = false;

        }

        return false;

    }



    function createCookie(name, value, days) {

        if (days) {

            var date = new Date();

            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));

            var expires = "; expires=" + date.toGMTString();

        }

        else var expires = "";

        document.cookie = name + "=" + value + expires + "; path=/";

    }



    function readCookie(name) {

        var nameEQ = name + "=";

        var ca = document.cookie.split(';');

        for (var i = 0; i < ca.length; i++) {

            var c = ca[i];

            while (c.charAt(0) == ' ') c = c.substring(1, c.length);

            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);

        }

        return null;

    }



    function eraseCookie(name) {

        createCookie(name, "", -1);

    }

</script>



<!-- END UE4 NOTICE -->



</div></div><div id="footer"><div style="BACKGROUND-COLOR: transparent; margin: 0; padding: 0; width: 100%;"><div>&nbsp;</div><div style="float: left; text-align: left; vertical-align: bottom; width: 50%;"><a href="http://www.videogamevoters.org"><img src="rsrc/vgvn.jpg" border="0" width="234" height="60" alt="Video Game Voters Network" /></a></div><div style="float: right; text-align: right; vertical-align: bottom; width: 50%;">Copyright &copy; 2001-2012 <a href="http://www.epicgames.com" target="_top">Epic Games, Inc.</a><br /><a href="../Main/TermsAndConditions.html" class="twikiLink">Terms and Conditions</a><br /><a href="http://epicgames.com/privacynotice" target="_top">Privacy Notice</a></div></div></div></div>
<p />
</html></body>
