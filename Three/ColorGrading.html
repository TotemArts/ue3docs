<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title> UDK | ColorGrading    </title>

<style type="text/css" media="all">@import "rsrc/twiki_webs.css";</style>
<style type="text/css" media="all">@import "rsrc/udn_new.css";</style>
<link rel="icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />


<!-- view.static_udn3.tmpl  -->
<script language="JavaScript" type="text/javascript" src="rsrc/udn.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

</head>
<p />
<body id="webbgThree">
<p />

<p />
<div id="webThree"><div id="head">
<!--
<div class="header">
 -->
<div style="background: url(/pub/webbg_udn.jpg); background-repeat: no-repeat; height:140px; width: 100%;" >
<!--
<div style="background: transparent url(/pub/udn_header_bg.jpg); background-repeat: repeat-x; height:140px; width: 100%; margin-left: 991px;">
 -->
<p />
<div id="nav">
<ul class="nav">
<font color=black>|</font>&nbsp;&nbsp;<li class=nav_Three><a href="../Main/WebHome.html" class="twikiLink">Main</a></li><font color=black>|</font><li class=nav_Three><a href="../Two/WebHome.html" class="twikiLink">UnrealEngine2</a></li><font color=black>|</font><li class=nav_Three><a href="WebHome.html" class="twikiLink">UnrealEngine3</a></li><font color=black>|</font><li class=nav_Three><a href="https://docs.unrealengine.com" class="twikiLink">UnrealEngine4</a></li><font color=black>|</font><li class=nav_Three><a href="../Main/BusinessAndLegal.html" class="twikiLink">Business &amp; Legal</a></li><font color=black>|</font>
</ul><br><br><br>
</div>
</div>
</div> <!-- end head -->
<div id="pagedefault">
<div id="maincol">
<div id="tool">
<div id="tooltop">UDN</div>
<div id="tooltext" style="padding: 10px 10px 10px 10px;">
Search public documentation: <br>
<form ACTION="/search/index.php" METHOD="GET" NAME="main" ID="main">
<input TYPE="TEXT" NAME="q" SIZE="15" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;">
<input TYPE="SUBMIT" VALUE="Search" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;"><br>
</form>
</div>
<div id="toolband">ColorGrading  </b></div>
<div id="tooltext">
<a href="ColorGradingJP.html" class="twikiLink">日本語訳</a><br><a href="ColorGradingCH.html" class="twikiLink">中国翻译</a><br><a href="ColorGradingKR.html" class="twikiLink">한국어</a><br>

<!-- Three/ColorGrading -->
<hr size="1" noshade="noshade" />
Interested in the Unreal Engine? <br>
Visit the <a href="http://www.unrealtechnology.com" target="_top">Unreal Technology</a> site.<br>
<br>
Looking for jobs and company info? <br>
Check out the <a href="http://www.epicgames.com" target="_top">Epic games</a> site.<br>
<br>
Questions about support via UDN? <br>
Contact the <a href="../Main/ContactUDNStaff.html" class="twikiLink">UDN Staff</a> <br>
<br>
</div> <!-- end toolbox content -->
<div id="toolbottom"></div>
</div> <!-- end tool -->
<p />
<noautolink>
<p />
<div style="padding:0px 0px 0px 4px;font:10px Verdana;">
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="PostProcessEffectsHome.html" class="twikiLink">Post Process Effects</a></b> &gt; Color Grading Post Process Feature <br/>
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="CinematicArtistHome.html" class="twikiLink">Cinematic Artist</a></b> &gt; Color Grading Post Process Feature
</div>
<hr size="1" noshade="noshade">
<h1><a name="Color Grading Post Process Feature"></a> Color Grading Post Process Feature </h1>
<hr size="1" noshade="noshade">
<p />
<table cellspacing="0" cellpadding="1" class="twikiTable" border="0"><tr><td bgcolor="#eaeaea" class="twikiFirstCol"> <img src="rsrc/Three/ColorGrading/Sandstorm_TonemappedColorgraded.jpg" alt="Sandstorm_TonemappedColorgraded.jpg" width='640' height='354' /> </td></tr>
<tr><td bgcolor="#ffffff" class="twikiFirstCol"> <SMALL>The images show the same scene with different color grading.</SMALL> </td></tr>
</table>
<br>
<p />
<div class="twikiToc"> <ul>
<li> <a href="ColorGrading.html#Color Grading Post Process Feature"> Color Grading Post Process Feature</a> <ul>
<li> <a href="ColorGrading.html#Overview"> Overview</a>
</li> <li> <a href="ColorGrading.html#The Tone mapper"> The Tone mapper</a>
</li> <li> <a href="ColorGrading.html#Color correction"> Color correction</a> <ul>
<li> <a href="ColorGrading.html#Work flow to create a LUT texture"> Work flow to create a LUT texture</a>
</li> <li> <a href="ColorGrading.html#Blending between LUT textures"> Blending between LUT textures</a>
</li> <li> <a href="ColorGrading.html#Combine math color adjustments with LUT textures"> Combine math color adjustments with LUT textures</a>
</li></ul>
</li> <li> <a href="ColorGrading.html#Further improvements"> Further improvements</a>
</li> <li> <a href="ColorGrading.html#Image Grain"> Image Grain</a>
</li> <li> <a href="ColorGrading.html#Internals (for programmers)"> Internals (for programmers)</a> <ul>
<li> <a href="ColorGrading.html#FLUTBlender class (for programmers)"> FLUTBlender class (for programmers)</a>
</li> <li> <a href="ColorGrading.html#Console variables"> Console variables</a>
</li> <li> <a href="ColorGrading.html#Optimizations (for programmers)"> Optimizations (for programmers)</a>
</li> <li> <a href="ColorGrading.html#Limitations"> Limitations</a>
</li></ul>
</li> <li> <a href="ColorGrading.html#Mobile Support"> Mobile Support</a> <ul>
<li> <a href="ColorGrading.html#Configuration"> Configuration</a>
</li> <li> <a href="ColorGrading.html#The Formula"> The Formula</a>
</li></ul>
</li> <li> <a href="ColorGrading.html#Links"> Links</a>
</li></ul>
</li></ul>
</div>
<p />
<p />
<h2><a name="Overview"></a> Overview </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Within the Unreal engine the term <strong>color grading</strong> covers the <strong>tone mapping</strong> function (HDR to LDR transformation) and the further <strong>color correction</strong> (LDR color to screen color transformation).
<p />
<h2><a name="The Tone mapper"></a> The Tone mapper </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
The purpose of the tone mapper function is to map the wide range of HDR (high dynamic range) colors into the small LDR (low dynamic range) so a monitor can display the color. This is done after normal rendering during post processing. A global tone mapper is a function with 3 inputs (RGB) and three outputs (RGB). A local tone mapper also takes into account the neighborhood of the pixel but is much more computationally intensive (means slower). A good tone mapper function tries to preserve the color of a pixel even if the color is very bright.
<p />
The following graph shows how each channel in the range from 0 to 5 is mapped to the new range of 0 to 1:
<p />
<img src="rsrc/Three/ColorGrading/newtone.jpg" alt="newtone.jpg" width='757' height='363' />
<p />
This is the used function:
<p />
<blockquote>
<pre>
GammaColor &#61; LinearColor / (LinearColor + 0.187) &#42; 1.035;
</pre>
</blockquote>
<p />
Note that bright colors become gradually brighter but much less than dark ones. Black remains black and there is a mostly linear part of the curve that is a bit steeper than the non tone-mapped curve would be. That results in some contrast enhancing. It's normal and expected to get a different look when using a tone mapper and in order to get a good result the source image needs to have more dynamic in the brightness (more HDR). This can pay off in a more realistic film like look.
<p />
The presented tone mapper formula already has two tweakable constants and more math would allow further tweaking but finding a good function is not easy as quality/flexibility/performance needs to be considered. We decided to stick to a simple formula and modify the resulting LDR color with a simple color lookup. As we already mapped the HDR color into a limited range we get a lot of expressibility for the dark colors and still can modify the bright colors. This method is simple to understand, offers a lot of flexibility with local control and almost constant performance.
<p />
You can enable the tone mapper by choosing the <strong>Filmic</strong> type in the editor (PostProcessChain / UberPostProcess).
<p />
<img src="rsrc/Three/ColorGrading/tonemapper.jpg" alt="tonemapper.jpg" width='484' height='219' />
<p />
You also can choose the tonemapper type. There is another <strong>Customizable</strong> tone mapper that works like the <strong>Filmic</strong> one. That one allows you to blend the bottom part of the tonemapper curve with a linear one (like if there was no tonemapper / linear mapping). This way you can control how much the darks are affected by the tonemapper. Be aware that this one is a slightly slower in render performance.
<p />
<h2><a name="Color correction"></a> Color correction </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
We implemented the color correction through lookup table. Instead of using three 1d lookup tables we decided to use one 3d lookup table as this offers more sophisticated color transformations (e.g. desaturation). The following image shows the 16x16x16 color neutral LUT unwrapped to a 256x16 texture (how it is currently visible in the texture browser):
<p />
<img src="rsrc/Three/ColorGrading/RGBTable16x1.png" alt="RGBTable16x1.png" width='256' height='16' /> (Don't copy this image from the web browser, right-click here and <em>Save link as...</em>: <a href="rsrc/Three/ColorGrading/RGBTable16x1.png">RGBTable16x1.png</a>)
<p />
A modified texture might look like this one:
<p />
<img src="rsrc/Three/ColorGrading/LUT_Sepia.png" alt="LUT_Sepia.png" width='256' height='16' />
<p />
<p />
To make use of a LUT you need to assign the LUT texture in the post process volume you want to use it.
<p />
<img src="rsrc/Three/ColorGrading/LUTSet.jpg" alt="LUTSet.jpg" width='714' height='392' />
<p />
<h3><a name="Work flow to create a LUT texture"></a> Work flow to create a LUT texture </h3>
<p />
The procedure: <ul>
<li> Make representative screen shots of the scenes you want to adjust and put them in one Photoshop document
</li> <li> Load a neutral 256x16 LUT into Photoshop (you can take the RGBTable16x1.png image from this page. Do not copy and paste, right-click here and <em>Save link as...</em>: <a href="rsrc/Three/ColorGrading/RGBTable16x1.png">RGBTable16x1.png</a>)
</li> <li> Insert the LUT into the Photoshop document with the screenshots (Select All in the LUT docuement, copy, switch to screenshot document, paste)
</li> <li> Apply color manipulations (best by adding adjustment layers, otherwise you need to flatten everything before and cutting out the 256x16 later gets more tricky)
</li> <li> Select the 256x16 LUT (Select the LUT layer in the layer panel, Menu: Select/Load Selection, Ok)
</li> <li> Copy merged the content of the LUT (Menu: Edit/Copy Merged)
</li> <li> Paste and save the 256x16 texture in some uncompressed format that the engine can read (Menu: File/New, Menu: Edit/Paste, Menu: File/Save As)
</li> <li> Import the texture in the editor and specify the ColorLookupTable Texture Group
</li></ul>
<p />
Various color corrections are possible. Here are a few examples: <ul>
<li> Brightness
</li> <li> Saturation
</li> <li> Simple contrast (linear with clamping)
</li> <li> Higher quality contrast (e.g. curves with a steeper linear part in the middle)
</li> <li> Selective changes to the darks, midtones and bright areas of an image (e.g. curves)
</li> <li> Selective changes to specific colors (best expressed in some color space where the brightness is in a separate channel e.g. LAB)
</li> <li> Adjustements can be even done in a different color space (e.g. LAB keeps brightness and color independent which can be very useful)
</li></ul>
<p />
<p />
<h3><a name="Blending between LUT textures"></a> Blending between LUT textures </h3>
<p />
In the game the textures are automatically blended over time (the same time value that was used for the former color correction). The performance impact of blending between multiple LUT is small.
<p />
<h3><a name="Combine math color adjustments with LUT textures"></a> Combine math color adjustments with LUT textures </h3>
<p />
Since long time the post processing allows color correction through a fixed formula (shadows, mid tones, highlights, saturation) but the math was done for each pixel on the screen. With a 3D lookup table we were now able to integrate the color transformation into the table after blending. The amount of math operations per frame is much less and as the postprocessing was a math (ALU) heavy shader we get a nice speedup.
<p />
<h2><a name="Further improvements"></a> Further improvements </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
We currently directly import the lookup texture as 256x16 texture. This isn't very intuitive and it's hard to interpret the image for an untrained eye. Some curve visualization or sample image would show more clearly what the texture does. We could even preview the effect on the current view when hovering over the entry in the content browser.
<p />
<h2><a name="Image Grain"></a> Image Grain </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Once <strong>Image Grain</strong> is activated you can see that some form of noise that changes the image color (before color grading). The noise is luminance only.
Using it can increase the filmic look of a scene. The noise is only affecting the darks and that strength can be adjusted (1 is the maximum but values up to 0.2 make sense).
<p />
     <img src="rsrc/Three/ColorGrading/ImageGrainEditor.jpg" alt="ImageGrainEditor.jpg" width='428' height='163' />
<p />
There is a small amount of noise that is always remaining (even if scale is 0) that affect the whole color range. This can help to improve quality. Internally colors are often processed in 8 bit per channel and that bit of noise can hide banding artifacts that come from that (e.g. seen in gradients).
<p />
<!--  -->
<p />
<h3><a name="Console variables"></a> Console variables </h3>
<p />
The console variable <strong>TonemapperType</strong> can be used to switch between different tonemapper types.
<p />
<img src="rsrc/Three/ColorGrading/tonemapperConsole.jpg" alt="tonemapperConsole.jpg" width='822' height='130' />
<p />
The console variable <strong>ColorGrading</strong> can be used to debug the blending or to see which LUT texture is currently in use.
<p />
<img src="rsrc/Three/ColorGrading/ColorGradingCon.jpg" alt="ColorGradingCon.jpg" width='822' height='81' />
<p />
The console variable <strong>ImageGrain</strong> can be used to tweak the image grain setting.
<p />
<img src="rsrc/Three/ColorGrading/ImageGrain.jpg" alt="ImageGrain.jpg" width='484' height='179' />
<p />
<p />
<!--  -->
<p />
<h3><a name="Limitations"></a> Limitations </h3>
<p /> <ul>
<li> Having only 16 distinct values per color axis is only approximating the color manipulations that have been done in the image processing tool (e.g. Photoshop). Also having only 256 output values might be limiting on some hardware (e.g. 10 bit DAC).
</li> <li> For performance reasons we don't interpolate the LUT in the shader (8 lookups) but use the texture filtering hardware instead. On older hardware (e.g. pre D3D10) the limited precision there can be noticable.
</li> <li> For Splitscreen each view is supposed to have it's own LUT blending.
</li> <li> Weighted blend is good to fade between LUT but sometimes it would be nice to layer effects (e.g. red tint on top of the environment LUT). Implementing that would be simple but dangerous. This would require dependent texture lookups during the blending and that can result in severe banding (imagine desaturating an image and saturating it again). Having only 16 table elements per axis would really hurt quality. As the former math color correction is still present it can be use used as a single procedural layer.
</li></ul>
<p />
<h2><a name="Mobile Support"></a> Mobile Support </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
LUT based color grading is not supported on mobile platforms. However, since the December 2011 release of Unreal Engine 3, a simplified, formula based implementation of color grading is available that allows content creators to control the desaturation, as well as the color appearance of highlights, mid-tones and shadows in a rendered scene on mobile devices. For ease of use, a new set of configuration properties has been added to the Post Process Settings of the <em>WorldInfo</em> and <em>PostProcessVolume</em> classes. Keep in mind, however, that these properties are used in a completely separate implementation that is specific to mobile platforms and not related to the familiar post-process chain on PC and consoles.
<p />
<h3><a name="Configuration"></a> Configuration </h3>
<p />
Mobile Color Grading is disabled by default. To enable the feature, set <code>MobileColorGrading=True</code> in the <em>[SystemSettings]</em> section of the game's <em>BaseEngine.ini</em> configuration file.
<p />
The actual visual appearance of the color grading effects is controlled through settings in the level editor. The <em>WorldInfo</em> class holds the map's default color grading settings in its <em>Mobile Color Grading</em> properties under <em>Default Poost Process Settings</em>. Similarly, <em>PostProcessVolumes</em> have the same set of properties in their general settings. The post-process volumes can be nested, and their respective color grading effects are applied when they are entered by the camera. Smooth blending between volume transitions is not yet supported at the time of this writing, but may be added in the future.
<p />
<p />
The following list is a description of the individual settings:
<p /> <ul>
<li> <strong>Blend</strong> - determines how much of the color grading is blended into the final scene. A value of 0.0 (default) means that color grading is disabled and has no effect, while a value 1.0 will apply 100% of the color grading result to the scene.
</li> <li> <strong>Desaturation</strong> - determines how much the color should be desaturated in the final scene. A value of 0.0 (default) applies no desaturation, while a value of 1.0 will fully desaturate the image (i.e. convert it to grayscale).
</li> <li> <strong>High Lights</strong> - controls the color correction on bright pixels in the scene.
</li> <li> <strong>Mid Tones</strong> - controls the color correction on mid tones.
</li> <li> <strong>Shadows</strong> - controls the color correction on dark pixels in the scene.
</li></ul>
<p />
<h3><a name="The Formula"></a> The Formula </h3>
<p />
The settings above are used in a calculation that is hard-coded into the GLSL shader for mobile platforms, which can be found and modified in the <em>Engine/Shaders/Mobile/Prefix_PixelShader.msf</em> mobile shader file. The Unreal Material Editor also includes an equivalent implementation in the form of the <em>MobileColorGrade</em> Material Function in the <em>MobileEngineMaterials</em> content package, which provides a very visual description of how the color grading function works internally.
<p />
However, it is important to remember that this material function is only used for the Mobile Emulation feature inside the editor, and it has no effect on the results on actual mobile devices. It is recommended to keep both the GLSL shader file and the material function in sync if modifications are being made to either one of them.
<p />
<img src="rsrc/Three/ColorGrading/mobile_color_grading_function.jpg" alt="Material Function for Mobile Color Grading.jpg" width='800' height='289' />
<p />
<h2><a name="Links"></a> Links </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p /> <ul>
<li> <strong>Using Lookup Tables to Accelerate Color Transformations</strong> by Jeremy Selan, GPUGems 2
</li></ul>
<p />
</noautolink>
<p />
<p />
<p />
<p />
<p />
<p />


<!-- BEGIN UE4 NOTICE -->



<div id="version_message" style="display:none;">

    <div style="position:fixed;top:0px;left:0px;width:100%;height:100%;background:#000;opacity:0.5;">

    </div>

    <div style="position:fixed;top:50%;left:50%;margin:-70px 0px 0px -240px;background:#FFF;border-radius:6px;width:480px;box-shadow:0px 5px 30px -5px rgba(0,0,0,0.9);">

        <div style="font-size:16px;font-weight:bold;background: url(rsrc/Three/warning.png) no-repeat scroll 5px 5px;padding:4px 10px 5px 25px;height:21px;width:440px;">

            Important!

        </div>

        <div style="font-size:11px;padding:5px 10px 10px;width:460px;">

            <p>You are viewing documentation for the <strong>Unreal Development Kit (UDK)</strong>.</p>



            <p>If you are looking for the Unreal Engine 4 documentation, please visit the <a style="color:#000;" href="https://docs.unrealengine.com">Unreal Engine 4 Documentation</a> site.</p>

        </div>

        <div style="height:20px;padding:4px;margin:6px;border-top:1px solid #a0a0a0;">

            <form onsubmit="return closeVersionMessage();">

                <input type="checkbox" id="dismiss" value="dismiss" />

                <label for="dsimiss">Don't show me this again</label>

                <input type="submit" value="Close" style="cursor:pointer;float:right;width:60px;color:#f0f0f0;font-weight:bold;background:#882222;height:24px;padding:2px 3px 3px;text-align:center;border:1px outset #000;" />

            </form>

        </div>

    </div>

</div>



<script type="text/javascript">

    window.onload = function () {

        LoadVersionMessage();

    }



    function LoadVersionMessage()

    {

        var showMessage = "false";
        if(showMessage != "false")

        {

            showVersionMessage();

        }

    }



    function showVersionMessage()

    {

        var message = document.getElementById("version_message");

        if(message)

        {

            message.style.display = "block";

        }

    }



    function closeVersionMessage() {

        var dismiss = document.getElementById("dismiss");

        var message = document.getElementById("version_message");

        if (message) {

            message.style.display = "none";

        }

        if (dismiss.checked) {

            eraseCookie("doc_version_message");

            createCookie("doc_version_message", "false", 365);

            dismiss.checked = false;

        }

        return false;

    }



    function createCookie(name, value, days) {

        if (days) {

            var date = new Date();

            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));

            var expires = "; expires=" + date.toGMTString();

        }

        else var expires = "";

        document.cookie = name + "=" + value + expires + "; path=/";

    }



    function readCookie(name) {

        var nameEQ = name + "=";

        var ca = document.cookie.split(';');

        for (var i = 0; i < ca.length; i++) {

            var c = ca[i];

            while (c.charAt(0) == ' ') c = c.substring(1, c.length);

            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);

        }

        return null;

    }



    function eraseCookie(name) {

        createCookie(name, "", -1);

    }

</script>



<!-- END UE4 NOTICE -->



</div></div><div id="footer"><div style="BACKGROUND-COLOR: transparent; margin: 0; padding: 0; width: 100%;"><div>&nbsp;</div><div style="float: left; text-align: left; vertical-align: bottom; width: 50%;"><a href="http://www.videogamevoters.org"><img src="rsrc/vgvn.jpg" border="0" width="234" height="60" alt="Video Game Voters Network" /></a></div><div style="float: right; text-align: right; vertical-align: bottom; width: 50%;">Copyright &copy; 2001-2012 <a href="http://www.epicgames.com" target="_top">Epic Games, Inc.</a><br /><a href="../Main/TermsAndConditions.html" class="twikiLink">Terms and Conditions</a><br /><a href="http://epicgames.com/privacynotice" target="_top">Privacy Notice</a></div></div></div></div>
<p />
</html></body>
