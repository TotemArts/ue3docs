<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title> UDK | VolumetricLightbeamTutorial    </title>

<style type="text/css" media="all">@import "rsrc/twiki_webs.css";</style>
<style type="text/css" media="all">@import "rsrc/udn_new.css";</style>
<link rel="icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />


<!-- view.static_udn3.tmpl  -->
<script language="JavaScript" type="text/javascript" src="rsrc/udn.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

</head>
<p />
<body id="webbgThree">
<p />

<p />
<div id="webThree"><div id="head">
<!--
<div class="header">
 -->
<div style="background: url(/pub/webbg_udn.jpg); background-repeat: no-repeat; height:140px; width: 100%;" >
<!--
<div style="background: transparent url(/pub/udn_header_bg.jpg); background-repeat: repeat-x; height:140px; width: 100%; margin-left: 991px;">
 -->
<p />
<div id="nav">
<ul class="nav">
<font color=black>|</font>&nbsp;&nbsp;<li class=nav_Three><a href="../Main/WebHome.html" class="twikiLink">Main</a></li><font color=black>|</font><li class=nav_Three><a href="../Two/WebHome.html" class="twikiLink">UnrealEngine2</a></li><font color=black>|</font><li class=nav_Three><a href="WebHome.html" class="twikiLink">UnrealEngine3</a></li><font color=black>|</font><li class=nav_Three><a href="https://docs.unrealengine.com" class="twikiLink">UnrealEngine4</a></li><font color=black>|</font><li class=nav_Three><a href="../Main/BusinessAndLegal.html" class="twikiLink">Business &amp; Legal</a></li><font color=black>|</font>
</ul><br><br><br>
</div>
</div>
</div> <!-- end head -->
<div id="pagedefault">
<div id="maincol">
<div id="tool">
<div id="tooltop">UDN</div>
<div id="tooltext" style="padding: 10px 10px 10px 10px;">
Search public documentation: <br>
<form ACTION="/search/index.php" METHOD="GET" NAME="main" ID="main">
<input TYPE="TEXT" NAME="q" SIZE="15" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;">
<input TYPE="SUBMIT" VALUE="Search" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;"><br>
</form>
</div>
<div id="toolband">VolumetricLightbeamTutorial  </b></div>
<div id="tooltext">
<a href="VolumetricLightbeamTutorialJP.html" class="twikiLink">日本語訳</a><br><a href="VolumetricLightbeamTutorialCH.html" class="twikiLink">中国翻译</a><br><a href="VolumetricLightbeamTutorialKR.html" class="twikiLink">한국어</a><br>

<!-- Three/VolumetricLightbeamTutorial -->
<hr size="1" noshade="noshade" />
Interested in the Unreal Engine? <br>
Visit the <a href="http://www.unrealtechnology.com" target="_top">Unreal Technology</a> site.<br>
<br>
Looking for jobs and company info? <br>
Check out the <a href="http://www.epicgames.com" target="_top">Epic games</a> site.<br>
<br>
Questions about support via UDN? <br>
Contact the <a href="../Main/ContactUDNStaff.html" class="twikiLink">UDN Staff</a> <br>
<br>
</div> <!-- end toolbox content -->
<div id="toolbottom"></div>
</div> <!-- end tool -->
<p />
<noautolink>
<p />
<div style="padding:0px 0px 0px 4px;font:10px Verdana;">
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="LightingAndShadowsHome.html" class="twikiLink">Lighting &amp; Shadows</a></b> &gt; Volumetric Light Beam Tutorial <br/>
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="ParticlesAndEffectsHome.html" class="twikiLink">Particle &amp; Effects</a></b> &gt; <b><a href="FogEffectsHome.html" class="twikiLink">Fog Effects</a></b> &gt; Volumetric Light Beam Tutorial
</div>
<hr size="1" noshade="noshade">
<h1><a name="Volumetric Light Beam Tutorial"></a> Volumetric Light Beam Tutorial </h1>
<hr size="1" noshade="noshade">
<p />
<div class="twikiToc"> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Volumetric Light Beam Tutorial"> Volumetric Light Beam Tutorial</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Overview"> Overview</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#What to Expect"> What to Expect</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#LightBeams"> LightBeams</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Creating the Static Mesh"> Creating the Static Mesh</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Creating the Material"> Creating the Material</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#FalloffTexture"> FalloffTexture</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Setting up the Material"> Setting up the Material</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Fixing the Artifacts"> Fixing the Artifacts</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Looks bad viewed from Underneath"> Looks bad viewed from Underneath</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Camera Intersects"> Camera Intersects</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#World Objects Intersect Light-beam"> World Objects Intersect Light-beam</a>
</li></ul>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Adding finishing touches"> Adding finishing touches</a> <ul>
<li> <a href="VolumetricLightbeamTutorial.html#Panning Smoke"> Panning Smoke</a>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Additional Parameters"> Additional Parameters</a>
</li></ul>
</li></ul>
</li></ul>
</li></ul>
</li> <li> <a href="VolumetricLightbeamTutorial.html#Final Thoughts"> Final Thoughts</a>
</li></ul>
</li></ul>
</div>
<p />
<h2><a name="Overview"></a> Overview </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
This guide is intended to act as an introduction to material techniques for creating a convincing volumetric light beam. We will use an unlit translucent material applied to a cone static mesh, using falloff to hide the edges.
<p />
Game engines have been using similar techniques to fake the appearance of volumetric lightbeams for many years now, but the most common techniques leave much to be desired.  How do you make a fake light-beam look correct from all angles? What if the player walks through the light beam? What if the beam intersects with world geometry? With the help of a few powerful material expressions, Unreal Engine 3 can solve all these problems with ease - and a bit of tweaking.
<p />
<h2><a name="What to Expect"></a> What to Expect </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
This tutorial will recreate the Master Lightbeam material found in the EngineVolumetrics package.
<p />
The full name of the finished material is: \\Build\UnrealEngine3-Build\Engine\Content\EngineVolumetrics.LightBeam.Materials.M_EV_Lightbeam_Master_01
<p />
Also note: \\Build\UnrealEngine3-Build\Engine\Content\EngineVolumetrics.LightBeam.Materials.M_EV_Lightbeam_Master_01_1sided_01 should be used when it's not necessary to see the interior of the lightbeam. We end up using the 1sided version most often for performance reasons.
<p />
EngineVolumetrics is a package containing four groups to contain the four types of volumetrics: FalloffSpheres, FogEnvironments, Fogsheets and Lightbeams. Of all the volumetric primitive types, the lightbeam was chosen as the tutorial material because it combines most of the techniques from all of the types into one material. The page explaining the various types of volumetric primitives and how to use them is the <a href="VolumetricLightingGuide.html" class="twikiLink">VolumetricLightingGuide</a>.
<p />
Since this material is to be used as the parent material of many instances, this tutorial will also show you how to configure a material with parameters for instancing. For a complete explanation material instancing, see the <a href="InstancedMaterials.html" class="twikiLink">InstancedMaterials</a> page.
<p />
<p />
<h2><a name="LightBeams"></a> LightBeams </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
There are limitless possibilities to what can be created, but we will start with a simple conical falloff type beam. These can be used in many different ways; they can be small and subtle to give a glow coming off a light source or scaled up to a god-beam-like-ray of light emanating through a hole in the clouds. They should match the existing atmosphere of a level; a level with dense distance fog should use denser lightbeams than a level with a clear atmosphere. Of course, this is entirely at the whim of the artist.
<p />
There are three steps to creating these light-beams.
1) Create the Static Mesh that defines the shape of the beam.
2) Create the falloff texture.
3) Create the Material and tweak values until all artifacts are gone.
<p />
<img alt="lightbeams.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/lightbeams.jpg" />
<p />
<h3><a name="Creating the Static Mesh"></a> Creating the Static Mesh </h3>
<p />
The EngineVolumetrics package already has three cone variants with different angles, but they all have the same UV’s. This section will tell you what you need to do in order to make more custom cone meshes to work with this material.
<p />
Create a cylinder with a tapered edge and unwrap it so that there is only one seam in the UV’s. It is important to have clean UV’s since the material calculations are done in tangent space and sloppy UV’s could cause visual distortion later on. The more tessellated your mesh is, the smoother the falloff will be for the end result (a 16-sided cylinder with 4 vertical slices is fine).
<p />
The three cone variants already in EngineVolumetrics should be enough for most cases.
<p />
<img alt="UDNLightmaps_Mesh01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_Mesh01.jpg" />
<p />
<h3><a name="Creating the Material"></a> Creating the Material </h3>
<p />
The creation of the material is the most involved part of the process. First we will get the light-beam functioning at its most basic level, then we will solve each one of the artifacts one at a time.
<p />
<h4><a name="FalloffTexture"></a> FalloffTexture </h4>
<p />
First we need to create a falloff texture. The appearance of the falloff texture is largely responsible for the appearance of the end result. This falloff texture has been created entirely with the Render-&gt;Light Effects filter in Photoshop. One fuzzy black line is drawn on top.
<p />
\\Build\UnrealEngine3-Build\Engine\Content\EngineVolumetrics.LightBeam.Materials. T_EV_LightBeam_Falloff_01
<p />
<p />
<img alt="T_LT_Light_UDNLightbeams_Materials_Falloff01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/T_LT_Light_UDNLightbeams_Materials_Falloff01.jpg" />
<p />
The important qualities to take note of are that the texture is completely black around all edges and the top of the texture fades to black. This helps to hide the position of the top edges of the Static Mesh. Make sure the texture properties are set to Clamp. The texture sample for this in the material will be a TextureSample2DParameter so that you can use a variety of different falloff textures on your lightbeams.
<p />
<h4><a name="Setting up the Material"></a> Setting up the Material </h4>
<p />
Now we are ready to start creating the material. Create a new material and set the following options in the material settings:
<p />
BlendMode: BLEND_Translucent
LightModel: MLM_Unlit
TwoSided: True
<p />
<img alt="UDNLightmaps_Material_start.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_Material_start.jpg" />
<p />
We will only be using two of the material input fields: Emissive and Opacity. The emissive field should contain only the color information of the beam. For now a simple VectorParameter (1, 1, 1, 1) is used for the emissive. The Alpha channel of the VectorParameter is multiplied by the RGB. This lets you use the Alpha as to modify the Brightness so that you can use the color picker to choose RGB values (which only supports values &lt;1) and still make the lightbeam insanely emissive if you want to. Being able to change luminosity independent of color is often very useful.
<p />
The opacity field is where most of the magic occurs. It will handle the falloff of the beam and may contain texture information to add dust or scrolling smoke.
<p />
We will use the falloff texture shown above as the opacity. For the texture coordinates of the falloff texture, we use a Reflection Vector to generate the X component while the Y component is supplied by the Static Mesh’s UV’s. This will orient the texture to face the camera along the X axis, relative to the static mesh’s rotation. Generating the X component takes a bit of work.
<p />
Reflection vectors output a range of numbers from -1 to 1. We want a range of numbers from 0-1 since we will be using the results as texture coordinates. We can change the range of a Reflection vector to be 0-1 simply by multiplying by 0.5, and then adding 0.5.
<p />
Once the range is correct, the AppendVector expression combines our Generated X coordinate with the Y coordinate in from the Static Mesh’s UV’s. The output of this AppendVector is ready to supply UV’s to our FalloffTexture
<p />
<img alt="UDNLightmaps_material01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material01.jpg" />
<p />
Here is what our light-beam now looks like:
<p />
<img alt="UDNLightmaps_Lightbeam01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_Lightbeam01.jpg" />
<p />
While this is a good starting point, our lightbeam material is by no means complete. Take a look at the artifacts we can introduce into the scene:
<p />
<img alt="UDNLightmaps_artifacting01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_artifacting01.jpg" />
<p />
As I said in the introduction to this guide, each of these problems can be solved by using the proper material expressions.
<p />
<h5><a name="Fixing the Artifacts"></a> Fixing the Artifacts </h5>
<p />
<h6><a name="Looks bad viewed from Underneath"></a> Looks bad viewed from Underneath </h6>
<p />
The method we are currently using (strictly X channel falloff) makes our beam look great when viewed from the side, but offers little help when the beam is viewed from an underneath angle. To correct the way the beam looks when viewed from underneath, we will use a second falloff texture and multiply it with our existing falloff texture. I used a blurry dot for the second falloff texture.
<p />
<img alt="T_LT_Light_UDNLightbeams_Materials_Falloff02.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/T_LT_Light_UDNLightbeams_Materials_Falloff02.jpg" />
<p />
Make sure the texture properties are set to Clamp.
<p />
Much like before, we use a reflection vector to generate texture coordinates for the second falloff texture. For the texture coordinates of this texture, we will use the X and Y components from the reflection vector. The ReflectionVector(X,Y) gets multiplied by a constant to adjust it slightly to better hide the edges. I used 0.3 but other values will work too.
<p />
<img alt="UDNLightmaps_material02.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material02.jpg" />
<p />
Here is what the light-beam should now look like when viewed from underneath:
<p />
<img alt="UDNLightmaps_artifacting_fixed01.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_artifacting_fixed01.jpg" />
<p />
No more hard edges should be visible. If you still see hard edges, you simply need to tweak the falloff texture or the multiple of the ReflectionVector(X,Y).
<p />
<h6><a name="Camera Intersects"></a> Camera Intersects </h6>
<p />
Using the PixelDepth node, we can sample the depth of any pixel within a translucent material. We will use this to fade out the pixels that are immediately in front of the camera. We can control the distance at which the fading occurs by multiplying the depth by a constant. For the constant, use a scalar parameter named ‘Distance’ so that it can be changed per-instance. Typically, you will want to change this value based on the size of the lightbeam you place. A very large beam should fade out from further back, and a small beam should allow the camera to get fairly close before starting to fade. A good default it 0.005.
<p />
It is important to clamp this result to a max of one. Simply multiply by the previous falloff texture result.
<p />
 <img alt="UDNLightmaps_material03.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material03.jpg" />
<p />
Before and After the distance fading has been applied:
<p />
 <img alt="UDNLightmaps_artifacting_fixed02.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_artifacting_fixed02.jpg" />
<p />
<h6><a name="World Objects Intersect Light-beam"></a> World Objects Intersect Light-beam </h6>
<p />
We can use DepthBiasedAlpha to fade the lightbeam along an intersection with world geometry.
<p />
Add the DepthBiasedBlendAlpha node and set its BiasScale to something around 500. A scalar parameter named ‘Density’ is used in the Bias input of the node, allowing further tweaking of the depth bias via material instances.
<p />
Since this material is meant to be the parent material for instances, and depthbiasedalpha is a fairly expensive expression, we are going to give it a StaticSwitchParameter so that it can be toggled on and off. It is set up so that the default is for it to be OFF.
<p />
<img alt="UDNLightmaps_material04.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material04.jpg" />
<p />
While the DepthBiasedAlpha technique is not perfect (it does not cause the lightbeam to be volumetrically shadowed), it does an excellent job of removing obvious artifacts from the scene.
<p />
<img alt="UDNLightmaps_artifacting_fixed03.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_artifacting_fixed03.jpg" />
<p />
<h5><a name="Adding finishing touches"></a> Adding finishing touches </h5>
<p />
<h6><a name="Panning Smoke"></a> Panning Smoke </h6>
<p />
We will also use a StaticSwitchParameter to give the option to enable a panning smoke texture within the beam. This is one reason that if you make additional beam meshes the UV’s should be neatly cylindrically unwrapped from 0 to 1 so that a smoke texture can pan without a seam where it tiles.
<p />
A texture parameter is added. It has several other parameters to control it’s behavior. Since lightbeams are often scaled along their length, the texture has separate parameters for X and Y scale. It also has parameters for panning speed and contrast.
<p />
The parameters are:
TextureContrast: Linear interpolates the texture with constant 1.
TextureScaleX: scales along X
TextureScaleY: scales along Y
PanningSpeed: multiplies time to control panning speed
<p />
Here is a screenshot:
<p />
<img alt="UDNLightmaps_material05.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material05.jpg" />
<p />
<h6><a name="Additional Parameters"></a> Additional Parameters </h6>
<p />
Lastly, we will be adding an additional multiply and a Scalar Parameter named “Opacity” to give final control of the beam’s opacity to the material instance.
<p />
<img alt="UDNLightmaps_material05.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_material05.jpg" />
<p />
<p />
<h2><a name="Final Thoughts"></a> Final Thoughts </h2>
<div style="margin-top:-10px;"><hr size="1" noshade="noshade"></div>
<p />
Here is what the final material looks like. At 21 instructions, this light-beam is still far cheaper than most lit materials. Turning on UseDepthBiasedAlpha and UseTextureOverlay bring the instruction count up to 39, so use those StaticSwitchParameters wisely.
<p />
With so much attention paid to the lighting features of next-gen engines, it is important not to underestimate the power of unlit materials.
<p />
<img alt="UDNLightmaps_mat_complete.jpg" src="rsrc/Three/VolumetricLightbeamTutorial/UDNLightmaps_mat_complete.jpg" />
<p />
</noautolink>
<p />
<p />
<p />
<p />
<p />
<p />


<!-- BEGIN UE4 NOTICE -->



<div id="version_message" style="display:none;">

    <div style="position:fixed;top:0px;left:0px;width:100%;height:100%;background:#000;opacity:0.5;">

    </div>

    <div style="position:fixed;top:50%;left:50%;margin:-70px 0px 0px -240px;background:#FFF;border-radius:6px;width:480px;box-shadow:0px 5px 30px -5px rgba(0,0,0,0.9);">

        <div style="font-size:16px;font-weight:bold;background: url(rsrc/Three/warning.png) no-repeat scroll 5px 5px;padding:4px 10px 5px 25px;height:21px;width:440px;">

            Important!

        </div>

        <div style="font-size:11px;padding:5px 10px 10px;width:460px;">

            <p>You are viewing documentation for the <strong>Unreal Development Kit (UDK)</strong>.</p>



            <p>If you are looking for the Unreal Engine 4 documentation, please visit the <a style="color:#000;" href="https://docs.unrealengine.com">Unreal Engine 4 Documentation</a> site.</p>

        </div>

        <div style="height:20px;padding:4px;margin:6px;border-top:1px solid #a0a0a0;">

            <form onsubmit="return closeVersionMessage();">

                <input type="checkbox" id="dismiss" value="dismiss" />

                <label for="dsimiss">Don't show me this again</label>

                <input type="submit" value="Close" style="cursor:pointer;float:right;width:60px;color:#f0f0f0;font-weight:bold;background:#882222;height:24px;padding:2px 3px 3px;text-align:center;border:1px outset #000;" />

            </form>

        </div>

    </div>

</div>



<script type="text/javascript">

    window.onload = function () {

        LoadVersionMessage();

    }



    function LoadVersionMessage()

    {

        var showMessage = "false";
        if(showMessage != "false")

        {

            showVersionMessage();

        }

    }



    function showVersionMessage()

    {

        var message = document.getElementById("version_message");

        if(message)

        {

            message.style.display = "block";

        }

    }



    function closeVersionMessage() {

        var dismiss = document.getElementById("dismiss");

        var message = document.getElementById("version_message");

        if (message) {

            message.style.display = "none";

        }

        if (dismiss.checked) {

            eraseCookie("doc_version_message");

            createCookie("doc_version_message", "false", 365);

            dismiss.checked = false;

        }

        return false;

    }



    function createCookie(name, value, days) {

        if (days) {

            var date = new Date();

            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));

            var expires = "; expires=" + date.toGMTString();

        }

        else var expires = "";

        document.cookie = name + "=" + value + expires + "; path=/";

    }



    function readCookie(name) {

        var nameEQ = name + "=";

        var ca = document.cookie.split(';');

        for (var i = 0; i < ca.length; i++) {

            var c = ca[i];

            while (c.charAt(0) == ' ') c = c.substring(1, c.length);

            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);

        }

        return null;

    }



    function eraseCookie(name) {

        createCookie(name, "", -1);

    }

</script>



<!-- END UE4 NOTICE -->



</div></div><div id="footer"><div style="BACKGROUND-COLOR: transparent; margin: 0; padding: 0; width: 100%;"><div>&nbsp;</div><div style="float: left; text-align: left; vertical-align: bottom; width: 50%;"><a href="http://www.videogamevoters.org"><img src="rsrc/vgvn.jpg" border="0" width="234" height="60" alt="Video Game Voters Network" /></a></div><div style="float: right; text-align: right; vertical-align: bottom; width: 50%;">Copyright &copy; 2001-2012 <a href="http://www.epicgames.com" target="_top">Epic Games, Inc.</a><br /><a href="../Main/TermsAndConditions.html" class="twikiLink">Terms and Conditions</a><br /><a href="http://epicgames.com/privacynotice" target="_top">Privacy Notice</a></div></div></div></div>
<p />
</html></body>
