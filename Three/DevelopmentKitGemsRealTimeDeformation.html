<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title> UDK | DevelopmentKitGemsRealTimeDeformation    </title>

<style type="text/css" media="all">@import "rsrc/twiki_webs.css";</style>
<style type="text/css" media="all">@import "rsrc/udn_new.css";</style>
<link rel="icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="rsrc/Three/WebPreferences/favicon.ico" type="image/x-icon" />


<!-- view.static_udn3.tmpl  -->
<script language="JavaScript" type="text/javascript" src="rsrc/udn.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

</head>
<p />
<body id="webbgThree">
<p />

<p />
<div id="webThree"><div id="head">
<!--
<div class="header">
 -->
<div style="background: url(/pub/webbg_udn.jpg); background-repeat: no-repeat; height:140px; width: 100%;" >
<!--
<div style="background: transparent url(/pub/udn_header_bg.jpg); background-repeat: repeat-x; height:140px; width: 100%; margin-left: 991px;">
 -->
<p />
<div id="nav">
<ul class="nav">
<font color=black>|</font>&nbsp;&nbsp;<li class=nav_Three><a href="../Main/WebHome.html" class="twikiLink">Main</a></li><font color=black>|</font><li class=nav_Three><a href="../Two/WebHome.html" class="twikiLink">UnrealEngine2</a></li><font color=black>|</font><li class=nav_Three><a href="WebHome.html" class="twikiLink">UnrealEngine3</a></li><font color=black>|</font><li class=nav_Three><a href="https://docs.unrealengine.com" class="twikiLink">UnrealEngine4</a></li><font color=black>|</font><li class=nav_Three><a href="../Main/BusinessAndLegal.html" class="twikiLink">Business &amp; Legal</a></li><font color=black>|</font>
</ul><br><br><br>
</div>
</div>
</div> <!-- end head -->
<div id="pagedefault">
<div id="maincol">
<div id="tool">
<div id="tooltop">UDN</div>
<div id="tooltext" style="padding: 10px 10px 10px 10px;">
Search public documentation: <br>
<form ACTION="/search/index.php" METHOD="GET" NAME="main" ID="main">
<input TYPE="TEXT" NAME="q" SIZE="15" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;">
<input TYPE="SUBMIT" VALUE="Search" STYLE="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: xx-small;"><br>
</form>
</div>
<div id="toolband">DevelopmentKitGemsRealTimeDeformation  </b></div>
<div id="tooltext">
<a href="DevelopmentKitGemsRealTimeDeformationJP.html" class="twikiLink">日本語訳</a><br><a href="DevelopmentKitGemsRealTimeDeformationCH.html" class="twikiLink">中国翻译</a><br><a href="DevelopmentKitGemsRealTimeDeformationKR.html" class="twikiLink">한국어</a><br>

<!-- Three/DevelopmentKitGemsRealTimeDeformation -->
<hr size="1" noshade="noshade" />
Interested in the Unreal Engine? <br>
Visit the <a href="http://www.unrealtechnology.com" target="_top">Unreal Technology</a> site.<br>
<br>
Looking for jobs and company info? <br>
Check out the <a href="http://www.epicgames.com" target="_top">Epic games</a> site.<br>
<br>
Questions about support via UDN? <br>
Contact the <a href="../Main/ContactUDNStaff.html" class="twikiLink">UDN Staff</a> <br>
<br>
</div> <!-- end toolbox content -->
<div id="toolbottom"></div>
</div> <!-- end tool -->
<p />
<noautolink>
<style type="text/css" media="all">@import "rsrc/UDNCSS_test.css";</style>
<div style="padding:0px 0px 0px 4px;font:10px Verdana;">
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="DevelopmentKitGems.html" class="twikiLink">Unreal Development Kit Gems</a></b> &gt; Real Time Deformation <br/>
<b><a href="WebHome.html" class="twikiLink">UE3 Home</a></b> &gt; <b><a href="MaterialsAndTexturesHome.html" class="twikiLink">Materials &amp; Textures</a></b> &gt; Real Time Deformation
</div>
<hr size="1" noshade="noshade">
<h1><a name="Real Time Deformation"></a> Real Time Deformation </h1>
<hr size="1" noshade="noshade">
<p />
<strong><em>Last tested against UDK June, 2011</em></strong>
<br>
<strong><em>PC with DX11 only</em></strong>
<p />
<div class="twikiToc"> <ul>
<li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Real Time Deformation"> Real Time Deformation</a> <ul>
<li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Overview"> Overview</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Technical Setup"> Technical Setup</a> <ul>
<li> <a href="DevelopmentKitGemsRealTimeDeformation.html#SceneCapture2DHitMaskComponent"> SceneCapture2DHitMaskComponent</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Material"> Material</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Unrealscript"> Unrealscript</a>
</li></ul>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#How to use DX11_DeformableMesh in game"> How to use DX11DeformableMesh in game</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Conclusion"> Conclusion</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Downloads"> Downloads</a>
</li> <li> <a href="DevelopmentKitGemsRealTimeDeformation.html#Related Topics"> Related Topics</a>
</li></ul>
</li></ul>
</div>
<p />
<h2><a name="Overview"></a> Overview </h2>
<hr size="1" noshade="noshade">
With the introduction of <a href="DirectX11Rendering.html" class="twikiLink">DirectX 11</a> into UDK, real time tessellation and displacement was added to dramatically improve the visual quality of Unreal rendered scenes. Displacement in DirectX 11 is more powerful than the <a href="WorldPositionOffset.html" class="twikiLink">World Position Offset</a> as it capable of using texture samplers. This alone makes vertex displacement more interesting. In this gem, we will discuss how to create a surface which can deform based on game play interactions.
<p />
In this screen shot, all of deformations is done in real time using the Link Gun. There is also two different types of materials, with the metal wall bending where the Link projectiles impacted. The floor is uses a rock diffuse, and when deformed it will pan a slime layer which also displaces the surface with a wavy style simulation.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11RealTimeDeformation.jpg" alt="DX11RealTimeDeformation.jpg" width='800' height='600' />
<p />
<strong>Note</strong>: DirectX 11 is required if you wish to use vertex displacement, but it is not needed if you just want to paint the surface of the mesh with a texture without having to use decals. Since DirectX 11 is disabled if the player doesn't have a DirectX 11 capable card, the shader will automatically turn it off.
<p />
<h2><a name="Technical Setup"></a> Technical Setup </h2>
<hr size="1" noshade="noshade">
This gem is comprised of two technologies working in tandem to produce the real time deformation. A <a href="HitMask.html" class="twikiLink">hit mask</a> is used to store all the deformations applied to the surface. This component will automatically transform world coordinates near the surface into the UV space coordinates and then draw a circle into the render target. Using the hit masks within the material, we can interpolate between two operations which comprise of the normal state and the damaged state. Lastly, Unrealscript collects altogether so that it can be used with script based interactions.
<p />
<h3><a name="SceneCapture2DHitMaskComponent"></a> SceneCapture2DHitMaskComponent </h3>
Normally you would use the hit mask component with specific texture coordinates as defined in the <a href="HitMask.html" class="twikiLink">documentation</a>. Unfortunately this texture coordinate set up is incompatible with DirectX 11's WorldDisplacement node. However with experimentation it was found that if a single plane referenced the entire UV coordinate set ([0.f - 1.f] in both axis) it was possible to use the hit mask render target by simply shifting the look up coordinates to just use [0.5f - 1.f] x [ 0.f - 1.f]. This does restrict the use of this gem to flat surfaces however.
<p />
<h3><a name="Material"></a> Material </h3>
The material system uses the hit mask component's render target as a mask to perform linear interpolation between different shader branches representing the deformed and non deformed areas.
<p />
Here are the nodes which simply sample the hit mask component's render target. The modified texture coordinates offset the effects of having to use Unmirror U which is normally required when using hit mask component. Only the red channel is used for interpolation purposes as the other channels do not provide any useful information.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11DeformMaterialLayout_HitMask.jpg" alt="DX11DeformMaterialLayout_HitMask.jpg" width='580' height='331' />
<p />
Here are the nodes which add the noise to the hit mask component's render target. Hit mask component's only place white circles which are pretty boring by themselves. By adding noise multiplied with these white circles, more interesting deformation is applied in the end.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11DeformMaterialLayout_NoiseMask.jpg" alt="DX11DeformMaterialLayout_NoiseMask.jpg" width='800' height='340' />
<p />
Here are the displacement vectors used by the material to apply to the material in question. These are set to 0.f, 0.f, 0.f, 1.f by default because Unrealscript changes these. It's important to use rotation orientated displacement vectors here otherwise the direction of the displacement will be incorrect. These vectors are set in Unrealscript.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11DeformMaterialLayout_DisplacementVectors.jpg" alt="DX11DeformMaterialLayout_DisplacementVectors.jpg" width='608' height='342' />
<p />
From here the rest of the material does not have any other special areas to mention. The diffuse, specular, specular power, normal and so forth should all use the noisy hit mask component render target for interpolation purposes so that the result of the deformation is even more pronounced.
<p />
<a href="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11DeformMaterialLayout.png"/><img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11DeformMaterialLayout_Thumbnail.jpg" alt="DX11DeformMaterialLayout_Thumbnail.jpg" width='800' height='1332' /></a>
<p />
<h3><a name="Unrealscript"></a> Unrealscript </h3>
Unrealscript here is used to bind the technologies together. When this actor is first created in the world, it will execute <strong>PostBeginPlay()</strong>. PostBeginPlay is equivalent to the constructor paradigm present in C++. In PostBeginPlay a render target is first created for the hit mask component to use. Optionally, you can make damage fade away by setting a positive value in <strong>SetFadingStartTimeSinceHit</strong>. This would allow the "surface" to return to normal over time and may be useful for things such as organic wall surfaces. After that, a material instance constant is created for the skeletal mesh, by using <strong>CreateAndSetMaterialInstanceConstant</strong>. The material instance constant that was created, then has the hit mask parameter set to the render target created before hand. Lastly the displacement vectors are then set based on the rotation of the actor.
<p />
When the actor is destroyed, <strong>Destroyed</strong> is executed. To facilitate garbage collection, any object references are set to none.
<p />
When the actor takes damage, <strong>TakeDamage</strong> is executed. Here is where the hit mask component is updated so that real time deformation occurs when the actor is being shot at by the Link Gun (or any other gun). A simple effect is done here, and it can be expanded to simulate other kinds of weapons, smaller or larger dents. The sky is the limit basically.
<p />
The default properties simply create all of the objects required and ensures that the actor is blocking and collidable.
<p />
<div class="codetitlebar">
<strong><em>DX11DeformableMesh.uc</em></strong>
</div>
<div class="codesnippet">
<pre>
class DX11DeformableMesh extends Actor
  placeable;

var() const LightEnvironmentComponent LightEnvironmentComponent;
var() const SkeletalMeshComponent SkeletalMeshComponent;
var() const SceneCapture2DHitMaskComponent SceneCapture2DHitMaskComponent;
var() const IntPoint HitMaskSize;
var() const Name HitMaskMaterialParameterName;
var() const Name MinimumDisplacementParameterName;
var() const Name MaximumDisplacementParameterName;
var() const float MinimumDisplacement;
var() const float MaximumDisplacement;

var TextureRenderTarget2D HitMaskRenderTarget;

simulated function PostBeginPlay()
{
  local MaterialInstanceConstant MaterialInstanceConstant;
  local LinearColor LC;
  local Vector V;

  Super.PostBeginPlay();

  HitMaskRenderTarget &#61; class&#39;TextureRenderTarget2D&#39;.static.Create(HitMaskSize.X, HitMaskSize.Y, PF&#95;G8, MakeLinearColor(0, 0, 0, 1));
  if (HitMaskRenderTarget !&#61; None)
  {
    SceneCapture2DHitMaskComponent.SetCaptureTargetTexture(HitMaskRenderTarget);
    SceneCapture2DHitMaskComponent.SetFadingStartTimeSinceHit(-1.f);

    if (SkeletalMeshComponent !&#61; None)
    {
      MaterialInstanceConstant &#61; SkeletalMeshComponent.CreateAndSetMaterialInstanceConstant(0);
      if (MaterialInstanceConstant !&#61; None)
      {
        MaterialInstanceConstant.SetTextureParameterValue(HitMaskMaterialParameterName, HitMaskRenderTarget);

        V &#61; Vector(Rotation);
        V &#42;&#61; MinimumDisplacement;
        LC.R &#61; V.X;
        LC.G &#61; V.Y;
        LC.B &#61; V.Z;
        MaterialInstanceConstant.SetVectorParameterValue(MinimumDisplacementParameterName, LC);

        V &#61; Vector(Rotation);
        V &#42;&#61; MaximumDisplacement;
        LC.R &#61; V.X;
        LC.G &#61; V.Y;
        LC.B &#61; V.Z;
        MaterialInstanceConstant.SetVectorParameterValue(MaximumDisplacementParameterName, LC);
      }
    }
  }
}

simulated function Destroyed()
{
  Super.Destroyed();

  SceneCapture2DHitMaskComponent.SetCaptureTargetTexture(None);
  HitMaskRenderTarget &#61; None;
}

simulated function TakeDamage(int DamageAmount, Controller EventInstigator, vector HitLocation, vector Momentum, class&#60;DamageType&#62; DamageType, optional TraceHitInfo HitInfo, optional Actor DamageCauser)
{
  Super.TakeDamage(DamageAmount, EventInstigator, HitLocation, Momentum, DamageType, HitInfo, DamageCauser);

  SceneCapture2DHitMaskComponent.SetCaptureParameters(HitLocation, 16.f, HitLocation, false);
}

defaultproperties
{
  Begin Object Class&#61;ArrowComponent Name&#61;Arrow
    ArrowColor&#61;(R&#61;150,G&#61;200,B&#61;255)
    bTreatAsASprite&#61;True
  End Object
  Components.Add(Arrow)

  Begin Object Class&#61;DynamicLightEnvironmentComponent Name&#61;MyDynamicLightEnvironmentComponent
  End Object
  LightEnvironmentComponent&#61;MyDynamicLightEnvironmentComponent
  Components.Add(MyDynamicLightEnvironmentComponent)

  Begin Object Class&#61;SkeletalMeshComponent Name&#61;MySkeletalMeshComponent
    LightEnvironment&#61;MyDynamicLightEnvironmentComponent
        bHasPhysicsAssetInstance&#61;true
    CollideActors&#61;true
    BlockActors&#61;true
    BlockZeroExtent&#61;true
    BlockNonZeroExtent&#61;true
    BlockRigidBody&#61;true
  End Object
  SkeletalMeshComponent&#61;MySkeletalMeshComponent
  CollisionComponent&#61;MySkeletalMeshComponent
  Components.Add(MySkeletalMeshComponent);

  Begin Object Class&#61;SceneCapture2DHitMaskComponent Name&#61;MySceneCapture2DHitMaskComponent
  End Object
  SceneCapture2DHitMaskComponent&#61;MySceneCapture2DHitMaskComponent
  Components.Add(MySceneCapture2DHitMaskComponent)

  CollisionType&#61;COLLIDE&#95;BlockAll
  BlockRigidBody&#61;true
  bCollideActors&#61;true
  bBlockActors&#61;true
  HitMaskSize&#61;(X&#61;512,Y&#61;512)
  HitMaskMaterialParameterName&#61;&#34;HeightMask&#34;
}
</pre>
</div>
<p />
<h2><a name="How to use DX11_DeformableMesh in game"></a> How to use DX11DeformableMesh in game </h2>
<hr size="1" noshade="noshade">
Using DX11DeformableMesh in game is as simple as using any other actor in Unreal Engine 3. Find the actor within the Content Browser, Actor Classes tab.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_ActorClasses.jpg" alt="DX11Deform_ActorClasses.jpg" width='486' height='530' />
<p />
Once selected in the Content Browser, you can then right click within the game viewport and add it to the world.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_PlaceActor.jpg" alt="DX11Deform_PlaceActor.jpg" width='544' height='544' />
<p />
From there, properties need to be set. You'll need to set the skeletal mesh component properties such as skeletal mesh, physics asset and material.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_DX11DeformSkelProp.jpg" alt="DX11Deform_DX11DeformSkelProp.jpg" width='572' height='534' />
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_DX11DeformMatProp.jpg" alt="DX11Deform_DX11DeformMatProp.jpg" width='572' height='534' />
<p />
Then you may want to tweak some of the deformation properties. Ensure that the material parameter names match with the material you're using.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_DX11DeformProp.jpg" alt="DX11Deform_DX11DeformProp.jpg" width='572' height='534' />
<p />
Lastly, you will need to ensure that the actor's facing direction points where the deformed surface is. The arrow helps to ensure that you orient them correctly. The plane mesh that is used also ensures this, but a plane is not strictly required for this technique to work. You can for example, make a mesh where not all portions are deformable.
<p />
<img src="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deform_Orientation.jpg" alt="DX11Deform_Orientation.jpg" width='800' height='578' />
<p />
<h2><a name="Conclusion"></a> Conclusion </h2>
<hr size="1" noshade="noshade">
By using multiple technologies together, it is possible to create interest new technology that can enhance your game and make it stand out from the crowd.
<p />
<h2><a name="Downloads"></a> Downloads </h2>
<hr size="1" noshade="noshade"> <ul>
<li> <a href="rsrc/Three/DevelopmentKitGemsRealTimeDeformation/DX11Deformation.zip" target="_top">Download</a> the content used for this gem.
</li></ul>
<p />
<h2><a name="Related Topics"></a> Related Topics </h2>
<hr size="1" noshade="noshade"> <ul>
<li> <a href="DirectX11Rendering.html" class="twikiLink">DirectX 11 Rendering</a>
</li> <li> <a href="HitMask.html" class="twikiLink">Hit Masks</a>
</li> <li> <a href="MaterialsCompendium.html" class="twikiLink">Materials Compendium</a>
</li></ul>
<p />
</noautolink>
<p />
<p />
<p />
<p />
<p />
<p />


<!-- BEGIN UE4 NOTICE -->



<div id="version_message" style="display:none;">

    <div style="position:fixed;top:0px;left:0px;width:100%;height:100%;background:#000;opacity:0.5;">

    </div>

    <div style="position:fixed;top:50%;left:50%;margin:-70px 0px 0px -240px;background:#FFF;border-radius:6px;width:480px;box-shadow:0px 5px 30px -5px rgba(0,0,0,0.9);">

        <div style="font-size:16px;font-weight:bold;background: url(rsrc/Three/warning.png) no-repeat scroll 5px 5px;padding:4px 10px 5px 25px;height:21px;width:440px;">

            Important!

        </div>

        <div style="font-size:11px;padding:5px 10px 10px;width:460px;">

            <p>You are viewing documentation for the <strong>Unreal Development Kit (UDK)</strong>.</p>



            <p>If you are looking for the Unreal Engine 4 documentation, please visit the <a style="color:#000;" href="https://docs.unrealengine.com">Unreal Engine 4 Documentation</a> site.</p>

        </div>

        <div style="height:20px;padding:4px;margin:6px;border-top:1px solid #a0a0a0;">

            <form onsubmit="return closeVersionMessage();">

                <input type="checkbox" id="dismiss" value="dismiss" />

                <label for="dsimiss">Don't show me this again</label>

                <input type="submit" value="Close" style="cursor:pointer;float:right;width:60px;color:#f0f0f0;font-weight:bold;background:#882222;height:24px;padding:2px 3px 3px;text-align:center;border:1px outset #000;" />

            </form>

        </div>

    </div>

</div>



<script type="text/javascript">

    window.onload = function () {

        LoadVersionMessage();

    }



    function LoadVersionMessage()

    {

        var showMessage = "false";
        if(showMessage != "false")

        {

            showVersionMessage();

        }

    }



    function showVersionMessage()

    {

        var message = document.getElementById("version_message");

        if(message)

        {

            message.style.display = "block";

        }

    }



    function closeVersionMessage() {

        var dismiss = document.getElementById("dismiss");

        var message = document.getElementById("version_message");

        if (message) {

            message.style.display = "none";

        }

        if (dismiss.checked) {

            eraseCookie("doc_version_message");

            createCookie("doc_version_message", "false", 365);

            dismiss.checked = false;

        }

        return false;

    }



    function createCookie(name, value, days) {

        if (days) {

            var date = new Date();

            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));

            var expires = "; expires=" + date.toGMTString();

        }

        else var expires = "";

        document.cookie = name + "=" + value + expires + "; path=/";

    }



    function readCookie(name) {

        var nameEQ = name + "=";

        var ca = document.cookie.split(';');

        for (var i = 0; i < ca.length; i++) {

            var c = ca[i];

            while (c.charAt(0) == ' ') c = c.substring(1, c.length);

            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);

        }

        return null;

    }



    function eraseCookie(name) {

        createCookie(name, "", -1);

    }

</script>



<!-- END UE4 NOTICE -->



</div></div><div id="footer"><div style="BACKGROUND-COLOR: transparent; margin: 0; padding: 0; width: 100%;"><div>&nbsp;</div><div style="float: left; text-align: left; vertical-align: bottom; width: 50%;"><a href="http://www.videogamevoters.org"><img src="rsrc/vgvn.jpg" border="0" width="234" height="60" alt="Video Game Voters Network" /></a></div><div style="float: right; text-align: right; vertical-align: bottom; width: 50%;">Copyright &copy; 2001-2012 <a href="http://www.epicgames.com" target="_top">Epic Games, Inc.</a><br /><a href="../Main/TermsAndConditions.html" class="twikiLink">Terms and Conditions</a><br /><a href="http://epicgames.com/privacynotice" target="_top">Privacy Notice</a></div></div></div></div>
<p />
</html></body>
